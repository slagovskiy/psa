Бонусы он-лайн.
Сергей Лаговский <lagovskiy@fotoland.ru>	 Tue, Aug 31, 2010 at 11:27 AM
To: Маздоров Виктор <viktor@fotoland.ru>, Солодков Константин <cio@fotoland.ru>
Бонусы он-лайн. Версия 3.

все находится здесь -> http://k.fotoland.ru/

1. Получение остатка на карте.
1.1 Получение уникального ключа для текущего сеанса связи
Его можно сгененировать самостоятельно или получить удаленно.
http://k.fotoland.ru/keygen.php - результат: 19216811140452946001280914601
если пойти по тому же пути и генерить самостоятельно 19216811140452946001280914601
Красное это Ip, с которого делается обращение, синее это значение внутренней переменной microtime в php, которая обеспечивает некоторую уникальность.
1.2 Запрос информации о карте
http://k.fotoland.ru/card.get.php?code=2700000010020&key=19216811140452946001280914601&format=csv
где: 
code это номер карты
key ключ текущего сеанса
format формат, в котором необходимо выдать данные, возможные значения csv или xml (по умолчанию)
В ответ приходит:
key;code;name;disc;discserv;phone;email;bonus;type 
19216811140452946001280914601;2700000010020;Алексеева Ирина Вениаминовна;5;7;2285344;;100;A
если был указан формат csv
или
<?xml version="1.0" encoding="windows-1251"?>
<DATA>
	<KEY>19216811140452946001280914601</KEY>
	<CARD>
<CODE>2700000010020</CODE>
	<NAME>Алексеева Ирина Вениаминовна</NAME>
	<DISC>5</DISC>
	<DISCSERV>7</DISCSERV>
	<PHONE>2285344</PHONE>
<EMAIL></EMAIL>
<BONUS>100</BONUS>
<TYPE>A</TYPE>
</CARD>
</DATA>
Если указан формат xml
поля:
key ключ текущего сеанса связи
code номер карты
name имя владельца карты
disc значение скидки на товары
discserv значение скидки на услуги
phone номер телефона владельца карты
email электронный адрес владельца карты
bonus количество бонусов на карте
type тип карты (для psa)


2. Списание бонусов.
2.1 Получение уникального ключа для текущего сеанса связи (см п. 1.1)
2.2 Передача данных о количестве бонусов, которые надо зарезервировать для списания (но реального списания не произойдет).
http://k.fotoland.ru/card.action.php?code=2700000010020&key=19216811140452946001280914601&action=add&bonus=-142
где
code номер карты
key ключ текущего сеанса
action действие, на первом шаге это добавление = add
bonus значение с минусом, количество бонусов, которое снимается
в ответ приходит:
OK. Confirm, please. - все прошло хорошо, можно переходить к пункту 2.3 для подтверждения своих действий
Not enough bonuses. - на карте не достаточно бонусов.
Card not found. - Указанная карта не найдена.
Action not found. - Указанное действие не найдено.
2.3 Подтверждение списания бонусов.
http://k.fotoland.ru/card.action.php?code=2700000010020&key=19216811140452946001280914601&action=confirm&bonus=-142
все параметры остались теми же, но значение действия сменилось на confirm.
В ответ приходит:
OK. - Значит списание произошло
Error deducting bonuses, repeat the procedure with the new key. - ошибка списания, необходимо повторить операцию, начиная с пункта 2.1


2. Списание бонусов.
2.1 Получение уникального ключа для текущего сеанса связи (см п. 1.1)
2.2 Передача данных о количестве бонусов, которые надо зарезервировать для списания (но реального списания не произойдет).
http://k.fotoland.ru/card.action.php?code=2700000010020&key=19216811140452946001280914601&action=add&bonus=-142&order=110000023523&dep=11
где
code номер карты
key ключ текущего сеанса
action действие, на первом шаге это добавление = add
bonus значение с минусом, количество бонусов, которое снимается
order номер заказа
dep код фотомаркета
в ответ приходит:
OK. Confirm, please. - все прошло хорошо, можно переходить к пункту 2.3 для подтверждения своих действий
Not enough bonuses. - на карте не достаточно бонусов.
Card not found. - Указанная карта не найдена.
Action not found. - Указанное действие не найдено.
2.3 Подтверждение списания бонусов.
http://k.fotoland.ru/card.action.php?code=2700000010020&key=19216811140452946001280914601&action=confirm&bonus=-142&order=110000023523&dep=11
все параметры остались теми же, но значение действия сменилось на confirm.
В ответ приходит:
OK. - Значит списание произошло
Error deducting bonuses, repeat the procedure with the new key. - ошибка списания, необходимо повторить операцию, начиная с пункта 2.1


3. Заполнение таблицы с бонусами
3.1 Копируется файл dcard.csv в директорию сайта, структура файла точно такая же как и для PSA.
3.2 Вызывается страничка http://k.fotoland.ru/card.new.php
В ответ приходит OK или текст с ошибкой и указанием на строку, содержащую эту ошибку.


4. Получение справочника дисконтных карт с учетом текущих списаний.
4.1 Получение уникального ключа для текущего сеанса (см п. 1.1)
4.2 Вызывается страничка http://k.fotoland.ru/card.list.php?format=csv&key=19216811140452946001280914601
где 
format формат вывода данных csv или xml (по умолчанию)
key ключ текущего сеанса
В ответ приходит страничка как и в п. 1.2, но уже не в виде информации о конкретной карте, а с полным перечислением всех карт.

5. Подготовка данных для РТ. Пока не используем
5.1 Загрузить файл bsaldo.csv в директорию сайта (без заголовков полей, в кодировку 1251)
5.2 Вызвать страничку http://k.fotoland.ru/bsaldo.new.php
В ответ придет ОК, если все прошло без ошибок или ошибка с ее описанием и строкой, на которой она произошла.

6. Импорт данных в РТ Пока не используем
6.1 Получить ключ сеанса (см п 1.1)
6.2 Вызвать скрипт http://k.fotoland.ru/bsaldo.list.php?format=csv?key=19216811140452946001280914601
где 
format это формат выходных данных, возможные варианты csv или xml (по умолчанию)
key ключ сеанса
Если указан фортам csv , в ответ приходит:
key;code;barcode;num;name;part;price;unit;serv;enum;nodisc;noret;qty;sect
125352001281001607;Т_ 6260;2100000062607;;Ф/Пл FUJI SUPERIA NEW 200 135/24 (100);;120;шт;F;T;F;F;5;0
125352001281001607;Т_ 6264;2100000062645;;Ф/Пл FUJI SUPERIA NEW 200 135/36 (100);;140;шт;F;T;F;F;5;0

Если указан формат xml:
<?xml version="1.0" encoding="windows-1251"?>
<DATA>
	<KEY>577080001280989403</KEY>
	<ROW>
<CODE>Т_ 6260</CODE>
	<BARCODE>2100000062607</BARCODE>
	<NUM></NUM>
	<NAME>Ф/Пл FUJI SUPERIA NEW 200 135/24 (100)</NAME>
	<PART></PART>
<PRICE>120</PRICE>
<UNIT>шт</UNIT>
<SERV>F</SERV>
<ENUM>T</ENUM>
<NODISC>F</NODISC>
	<NORET>F</NORET>
<QTY>5</QTY>
<SECT>0</SECT>
</ROW>
<ROW>
<CODE>Т_ 6264</CODE>
<BARCODE>2100000062645</BARCODE>
	<NUM></NUM>
<NAME>Ф/Пл FUJI SUPERIA NEW 200 135/36 (100)</NAME>
<PART></PART>
<PRICE>140</PRICE>
<UNIT>шт</UNIT>
<SERV>F</SERV>
<ENUM>T</ENUM>
	<NODISC>F</NODISC>
<NORET>F</NORET>
<QTY>5</QTY>
<SECT>0</SECT>
</ROW>
</DATA>
Это полная копия данных, которые передаются в dbf


7. Передача данных о продажах из РТ Пока не используем
7.1 Получить ключ (см п. 1.1)
7.2 Передать данные, вызвав скрипт:
http://k.fotoland.ru/sales.action.php
Скрипт имеет следующие параметры:
key уникальный ключ
action действие, на этом шаге оно равно add
далее идут поля из таблицы sales.dbf и их значения (date=03.08.10&time=08:27:55&cash=1&shift=870&check=1&sect=0&sign=1&code=Т_     60659&discard=&credcard=&discsum=0&credsum=0&sum=12&qty=1&barcode=873999002122&dgsum=0&dtsum=0&dssum=0&ddsum=0&cnum=3&user=Шенкнехт Л.И.&price=12), формат передачи даты = YYYY/MM/DD, формат передачи времени = HH:MM:SS
если поле не передано, то оно заполняется значением по умолчанию (для числовых полей = 0, для строковых = пустая строка)
В ответ приходит:
OK. Confirm, please. - Если все хорошо, нужно переходить к шагу 7.3
Action not found. - Если не верно передано действие
7.3 Подтверждение записи
Для подтверждения нужно вызвать тот же самый скрипт, со всеми теми же параметрами, но в качестве действия указать confirm, процедура схожая со списанием бонусов.
В ответ приходит или ОК, или Error adding information about the sale, repeat the procedure with the new key.

8. Контроль данных о продажах на момент отладки Пока не используем
Есть скрипт http://k.fotoland.ru/sales.list.php?format=xml&key=19216811140452946001280914601
он выводит содержимое таблицы sales в виде csv или xml, все поля точно такие же как в sales.dbf, но добавлены еще 3-и поля, key, это ключ, который использовался для добавления этих данных, del, если эта строка помечена как удаленная (в случае импорта ее в 1с), и commit, если добавленные данные были подтверждены (в противном случае они не рассматриваются)


Новое для 1С.
9. Импорт данных по списанию бонусов с бонусных карт.
9.1 Вызываем скрипт http://k.fotoland.ru/card.export.php?format=csv
где format это тип вывода, возможен вариант xml или csv
Результатом работы скрипта будет страница, содержащая xml или csv документ, а так же копия этого документа на диске.
xml: k.fotoland.ru/export/dcard-20100831-102800.xml 
<?xml version="1.0" encoding="windows-1251"?>
<DATA>
	<KEY>055312001283225280</KEY> ключ, для 1с можно не использовать, он уникален для события, в данном случае запрос списаний.
	<FILE>dcard-20100831-102800.xml</FILE> файл, в котором содержится копия данных
	<ACTION> таблица действий
	<ID>11</ID> идентификатор записи
	<DATE>2010-08-30 17:48:05</DATE> дата события
	<CODE>2700000010181</CODE> номер карты
	<KEY>19216812350518292001283164519</KEY> ключ с которым совершалась эта операция
	<BONUS>-95.00</BONUS> количество бонусов для списания
	<COMMIT>1</COMMIT> флаг того, что эта запись подтверждена
	<DEL>0</DEL> флаг того, что эта запись ранее не импортировалась (если 0)
	</ACTION>
</DATA>
те же данные, но в csv формате:
id;date;code;key;bonus;commit;del;file
11;2010-08-30 17:48:05;2700000010181;19216812350518292001283164519;-95.00;1;0;dcard-20100831-105303.csv
12;2010-08-31 09:48:26;2700000010525;19216812350046605001283222901;-65.00;1;0;dcard-20100831-105303.csv
16;2010-08-31 10:09:32;2700000010525;20100830141655952;-10.30;1;0;dcard-20100831-105303.csv
15;2010-08-31 10:09:49;2700000010525;20100830141655952;-10.30;1;0;dcard-20100831-105303.csv
14;2010-08-31 10:09:59;2700000010525;20100830141655952;-10.50;1;0;dcard-20100831-105303.csv
13;2010-08-31 10:10:09;2700000010525;20100830141655952;-10.50;1;0;dcard-20100831-105303.csv


9. Импорт данных по списанию бонусов с бонусных карт.
9.1 Вызываем скрипт http://k.fotoland.ru/card.export.php?format=csv
где format это тип вывода, возможен вариант xml или csv
Результатом работы скрипта будет страница, содержащая xml или csv документ, а так же копия этого документа на диске.
xml: k.fotoland.ru/export/dcard-20100831-102800.xml 
<?xml version="1.0" encoding="windows-1251"?>
<DATA>
	<KEY>055312001283225280</KEY> ключ, для 1с можно не использовать, он уникален для события, в данном случае запрос списаний.
	<FILE>dcard-20100831-102800.xml</FILE> файл, в котором содержится копия данных
	<ACTION> таблица действий
		<ID>11</ID> идентификатор записи
		<DATE>2010-08-30 17:48:05</DATE> дата события
		<CODE>2700000010181</CODE> номер карты
		<KEY>19216812350518292001283164519</KEY> ключ с которым совершалась эта операция
		<BONUS>-95.00</BONUS> количество бонусов для списания
		<ORDER>1100000023523</ORDER> номер заказа
		<DEP>11</DEP> код фотомаркета
		<COMMIT>1</COMMIT> флаг того, что эта запись подтверждена
		<DEL>0</DEL> флаг того, что эта запись ранее не импортировалась (если 0)
	</ACTION>
</DATA>
те же данные, но в csv формате:
id;date;code;key;bonus;order;dep;commit;del;file
11;2010-08-30 17:48:05;2700000010181;19216812350518292001283164519;-95.00;110000003456;11;1;0;dcard-20100831-105303.csv



Последовательность работы:
1. Данные по остаткам на картах загружаются в базу (см процедуру 3).
2. В базу вносятся списания бонусов (процедура 2).
3. По окончанию дня забираются данные по списаниям бонусов (процедура 9).
4. 1с делает пересчет выкладывает файл для импорта в базу и дальше возвращаемся на пункт 1.
Важно, что бы 4-й шаг произошел, если был выполнен 3-й, иначе получим, что данные о списании забрали, а новые данные не выложили и на утро получим вчерашние бонусы.

для доступа используется пользователь bonus с паролем b0nu$$
k.fotoland.ru = 192.168.1.46
в рабочей папке пользователя находится папка k.fotoland.ru, в нее ложится файл импорта остатков дисконтных карт (процедура 3), в подпапке k.fotoland.ru/export собираются файлы экспорта списаний бонусов.
